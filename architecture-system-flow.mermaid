graph TB
    %% User Journey & Entry Points
    subgraph "ğŸ¯ User Journey & Entry Points"
        Install[("ğŸ”½ Chrome Extension<br/>Installation")]
        ExtIcon[("ğŸ›ï¸ Extension Icon<br/>Click")]
        TwitterPage[("ğŸ¦ Twitter/X<br/>Page Visit")]
        ReplyClick[("ğŸ’¬ Reply Button<br/>Click")]
    end

    %% Extension Popup Interface
    subgraph "âš™ï¸ Extension Settings Popup (400x500px)"
        PopupHeader[("ğŸ“Œ Header<br/>Logo + Title<br/>'TweetCraft'")]
        APIKeySection[("ğŸ”‘ API Key Section<br/>â€¢ OpenRouter Key Input<br/>â€¢ Show/Hide Toggle<br/>â€¢ Test Connection Button")]
        ModelSection[("ğŸ¤– Model Selection<br/>â€¢ Model Dropdown<br/>â€¢ Refresh Models Button<br/>â€¢ Model Info Display")]
        PersonalitySection[("ğŸ­ Personality Settings<br/>â€¢ System Prompt Textarea<br/>â€¢ Your Writing Style")]
        AdvancedSection[("âš™ï¸ Advanced Settings<br/>â€¢ Temperature Slider (0.1-1.0)<br/>â€¢ Context Mode Select")]
        SaveButton[("ğŸ’¾ Save Settings<br/>Button")]
        StatusMessage[("ğŸ“Š Status Messages<br/>Success/Error Display")]
    end

    %% AI Reply Interface on Twitter
    subgraph "ğŸ¦ Twitter/X Integration"
        AIReplyButton[("âœ¨ AI Reply Button<br/>Injected in Reply Toolbar")]
        
        subgraph "ğŸ¨ Tone Selector Dropdown"
            ToneHeader[("Select Tone Header<br/>with Expand Button â–¼")]
            ToneGrid[("ğŸ­ 12 Tone Grid<br/>ğŸ’¼ Professional | ğŸ˜Š Casual<br/>ğŸ˜„ Witty | ğŸ¤— Supportive<br/>ğŸ‰ Excited | ğŸ“ Academic<br/>ğŸ¤” Counter | ğŸ¤¨ Skeptic<br/>ğŸ˜ Sarcastic | ğŸ”¥ Spicy<br/>ğŸ™„ Dismissive | âœ¨ Custom")]
            CustomPrompt[("âœï¸ Custom Prompt<br/>Textarea (when Custom selected)")]
            MoodModifiers[("ğŸšï¸ Quick Modifiers<br/>Optional mood adjustments")]
            TonePreview[("ğŸ‘ï¸ Tone Preview<br/>Emoji + Description")]
            GenerateButton[("âš¡ Generate Reply Button")]
        end
        
        subgraph "ğŸ“ Preset Templates Panel"
            TemplatesHeader[("ğŸ“‹ Templates Toggle")]
            TemplateGrid[("ğŸ“š Template Categories<br/>ğŸ¯ Engagement | ğŸ’¡ Value<br/>ğŸ’¬ Conversation | ğŸ˜„ Humor")]
            TemplateOptions[("ğŸ“ Individual Templates<br/>â“ Ask Question<br/>ğŸ‘ Agree & Expand<br/>ğŸ’¡ Add Value<br/>ğŸ”„ Share Experience<br/>+ Create Custom")]
            CreateDialog[("â• Create Custom Template<br/>Name, Emoji, Category, Prompt")]
        end
    end

    %% Processing & Generation
    subgraph "ğŸ§  AI Processing Pipeline"
        ContextExtraction[("ğŸ” Context Extraction<br/>â€¢ Tweet Text<br/>â€¢ Author Info<br/>â€¢ Thread Context (up to 4 tweets)<br/>â€¢ Context Mode Processing")]
        
        RequestBuilder[("ğŸ“¦ Request Builder<br/>â€¢ Selected Tone<br/>â€¢ Custom Prompt<br/>â€¢ Mood Modifiers<br/>â€¢ System Prompt<br/>â€¢ Temperature")]
        
        CacheCheck[("ğŸ’¾ Cache Check<br/>Session-based caching<br/>Tweet ID + Tone key")]
        
        OpenRouterAPI[("ğŸŒ OpenRouter API Call<br/>â€¢ Model Selection<br/>â€¢ Rate Limiting<br/>â€¢ Retry Logic<br/>â€¢ Error Handling")]
        
        ResponseProcessing[("âš¡ Response Processing<br/>â€¢ Cleanup meta-text<br/>â€¢ URL tracking removal<br/>â€¢ Character validation")]
        
        CacheStore[("ğŸ’½ Cache Storage<br/>Store for session<br/>Tweet ID + Tone key")]
    end

    %% UI States & Feedback
    subgraph "ğŸ“± UI States & Feedback"
        LoadingState[("â³ Loading State<br/>Spinner animation<br/>Button disabled")]
        
        SuccessState[("âœ… Success State<br/>Text inserted to textarea<br/>Character count updated<br/>Dropdown closes")]
        
        ErrorStates[("âŒ Error States<br/>â€¢ No API Key<br/>â€¢ Invalid API Key<br/>â€¢ Rate Limited<br/>â€¢ Network Error<br/>â€¢ Server Error")]
        
        ToastNotifications[("ğŸ”” Toast Notifications<br/>Bottom-center overlay<br/>Auto-dismiss after 5s<br/>Success/Warning/Error styles")]
    end

    %% Background Services
    subgraph "ğŸ”§ Background Services"
        ServiceWorker[("âš™ï¸ Service Worker<br/>â€¢ Message handling<br/>â€¢ Storage management<br/>â€¢ API key validation<br/>â€¢ Model fetching")]
        
        StorageService[("ğŸ’¾ Storage Service<br/>â€¢ Chrome sync storage<br/>â€¢ Local storage<br/>â€¢ Session storage")]
        
        MemoryManager[("ğŸ§¹ Memory Manager<br/>â€¢ Event listener tracking<br/>â€¢ Cleanup on navigation<br/>â€¢ Resource management")]
        
        ErrorHandler[("ğŸ› ï¸ Error Handler<br/>â€¢ Global error catching<br/>â€¢ Recovery strategies<br/>â€¢ User-friendly messages")]
    end

    %% Data Flow Connections
    Install --> PopupHeader
    ExtIcon --> PopupHeader
    TwitterPage --> AIReplyButton
    ReplyClick --> AIReplyButton
    
    APIKeySection --> ServiceWorker
    ModelSection --> ServiceWorker
    SaveButton --> StorageService
    
    AIReplyButton --> ToneGrid
    ToneGrid --> GenerateButton
    CustomPrompt --> GenerateButton
    MoodModifiers --> GenerateButton
    TemplateOptions --> GenerateButton
    
    GenerateButton --> ContextExtraction
    ContextExtraction --> RequestBuilder
    RequestBuilder --> CacheCheck
    CacheCheck --> OpenRouterAPI
    OpenRouterAPI --> ResponseProcessing
    ResponseProcessing --> CacheStore
    ResponseProcessing --> SuccessState
    
    LoadingState --> OpenRouterAPI
    OpenRouterAPI --> ErrorStates
    ErrorStates --> ToastNotifications
    
    ServiceWorker --> StorageService
    ServiceWorker --> ErrorHandler
    ErrorHandler --> MemoryManager

    %% Styling
    classDef userJourney fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef popup fill:#fff3e0,stroke:#f57c00,stroke-width:2px  
    classDef twitter fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef processing fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef states fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef services fill:#e0f2f1,stroke:#00695c,stroke-width:2px
    
    class Install,ExtIcon,TwitterPage,ReplyClick userJourney
    class PopupHeader,APIKeySection,ModelSection,PersonalitySection,AdvancedSection,SaveButton,StatusMessage popup
    class AIReplyButton,ToneHeader,ToneGrid,CustomPrompt,MoodModifiers,TonePreview,GenerateButton,TemplatesHeader,TemplateGrid,TemplateOptions,CreateDialog twitter
    class ContextExtraction,RequestBuilder,CacheCheck,OpenRouterAPI,ResponseProcessing,CacheStore processing
    class LoadingState,SuccessState,ErrorStates,ToastNotifications states
    class ServiceWorker,StorageService,MemoryManager,ErrorHandler services
